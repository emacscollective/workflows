#!/bin/sh
":"; exec emacs -Q --script "$0" -- "$@" # -*- mode: emacs-lisp; lexical-binding: t; -*-

(load (expand-file-name "../../lib/common" load-file-name))

(defun main ()
  (let ((file (expand-file-name "default.mk")))
    (unless (file-exists-p file)
      (setq file (expand-file-name "Makefile")))
    (with-temp-buffer
      (insert-file-contents file)
      (while (re-search-forward "^DEPS +\\+?= +\\([^/\n]+\\)" nil t)
        (let ((dep (match-string 1)))
          (msg "â€¢ Cloning %s" dep)
          (run "git" "clone" "--depth" "1"
               (concat "https://github.com/emacsmirror/" dep)
               (concat "../" dep))
	  (when (equal dep "compat")
	    (let ((default-directory
		   (expand-file-name "../compat/" default-directory)))
              (run "make" "all"))))))))

(kill-emacs (catch 'return (prog1 0 (main))))
